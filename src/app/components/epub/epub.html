<ion-header class="ion-no-border">
  <ion-toolbar class="secondary">

    <ng-container *ngIf="epubFileExists">
      <div *ngIf="userSettingsService.isDesktop() && !loading" class="epub-nav-buttons">
        <ion-button id="epub-arrow-prev"
              class="navigation-buttons"
              [class.disabled-nav-button]="atStart"
              [disabled]="atStart"
              (click)="prev()"
        >
          <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
        </ion-button>
        <p class="current-section-label" [innerHTML]="currentSectionLabel"></p>
        <ion-button id="epub-arrow-next"
              class="navigation-buttons"
              [class.disabled-nav-button]="atEnd"
              [disabled]="atEnd"
              (click)="next()"
        >
          <ion-icon slot="icon-only" name="arrow-forward"></ion-icon>
        </ion-button>
      </div>

      <ion-buttons slot="end" class="secondary-toolbar-buttons-wrapper">
        <ion-button (click)="openDownloadURL()">
          <ion-icon slot="start" name="download"></ion-icon>
          <span class="side-title" i18n="@@Epub.Download">Ladda ner</span>
        </ion-button>
        <ion-button *ngIf="showURNButton" (click)="showReference()">
          <ion-icon slot="start" name="arrow-redo-sharp"></ion-icon>
          <span class="side-title" i18n="@@Reference.refer">Hänvisa</span>
        </ion-button>
        <ion-button *ngIf="showViewOptionsButton" (click)="showReadSettingsPopover($event)">
          <ion-icon slot="start" name="settings"></ion-icon>
          <span class="side-title" i18n="@@Epub.DisplayOptions">Textstorlek</span>
        </ion-button>
        <ion-button (click)="toggleSearchMenu()">
          <ion-icon slot="start" name="search" [class.visuallyhidden]="searchMenuOpen"></ion-icon>
          <ion-icon slot="start" name="close" [class.visuallyhidden]="!searchMenuOpen"></ion-icon>
          <span class="side-title" i18n="@@Epub.Search">Sök</span>
        </ion-button>
        <ion-button [ngClass]="tocMenuOpen ? 'menuOpenTOC' : 'menuClosedTOC'" (click)="toggleTocMenu()">
          <ion-icon slot="start" name="list" [class.visuallyhidden]="tocMenuOpen"></ion-icon>
          <ion-icon slot="start" name="close" [class.visuallyhidden]="!tocMenuOpen"></ion-icon>
          <span class="side-title" i18n="@@Epub.Contents">Innehåll</span>
        </ion-button>
      </ion-buttons>
    </ng-container>

  </ion-toolbar>
</ion-header>

<ion-content class="epub-ion-content">
  <div class="epub-content-wrapper" [class.mobile-mode-epub]="userSettingsService.isMobile()">

    <div class="toc-epub-container">
      <div *ngIf="loading" class="spinner-wrapper">
        <ion-spinner class="loading" name="crescent"></ion-spinner>
      </div>
      <div *ngIf="epubFileExists" id="epub-render-area"></div>
      <p *ngIf="!epubFileExists" class="epub-error-message" i18n="@@Epub.FileNotFound">Texten kunde inte laddas. Epub-filen saknas.</p>
    </div>

    <div class="current-position-container" *ngIf="!loading && epubFileExists">
      <span [innerHTML]="currentPositionPercentage"></span>
    </div>
  </div>

  <div *ngIf="userSettingsService.isMobile() && epubFileExists" class="epub-nav-buttons mobile-mode-epub">
    <ng-container *ngIf="!loading">
      <ion-button id="epub-arrow-prev"
            class="navigation-buttons"
            [class.disabled-nav-button]="atStart"
            [disabled]="atStart"
            (click)="prev()"
      >
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
      <p class="current-section-label" [innerHTML]="currentSectionLabel"></p>
      <ion-button id="epub-arrow-next"
            class="navigation-buttons"
            [class.disabled-nav-button]="atEnd"
            [disabled]="atEnd"
            (click)="next()"
      >
        <ion-icon slot="icon-only" name="arrow-forward"></ion-icon>
      </ion-button>
    </ng-container>
  </div>

  <div *ngIf="!loading" id="epub-search-menu" [ngClass]="searchMenuOpen ? 'searchOpen' : 'searchClosed'">
    <ion-searchbar class="epub-search-bar"
          (ionInput)="doSearch($event)"
          (ionClear)="clearSearch()"
          [(ngModel)]="searchText"
          placeholder="Söktext"
          i18n-placeholder="@@Epub.SearchPhrase"
          inputmode="text"
          [debounce]="250"
    ></ion-searchbar>
    <ion-button fill="clear"
          class="navigation-buttons"
          (click)="prevSearch()"
          [disabled]="searchResults.length < 1 || (searchResultIndex === 0 && searchResults.length > 0)"
    >
      <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
    </ion-button>
    <div class="search-count">
      <span *ngIf="searchResultIndex === 0 && searchResults.length>0">1 / {{searchResults.length}}</span>
      <span *ngIf="searchResultIndex > 0">{{searchResultIndex + 1}} / {{searchResults.length}}</span>
    </div>
    <ion-button fill="clear"
          class="navigation-buttons"
          (click)="nextSearch()"
          [disabled]="searchResults.length < 1 || searchResultIndex > searchResults.length-2"
    >
      <ion-icon slot="icon-only" name="arrow-forward"></ion-icon>
    </ion-button>
  </div>

  <div id="epub-toc-menu"
        [ngClass]="tocMenuOpen ? 'menuOpen' : 'menuClosed'"
        [class.mobile-mode-epub]="userSettingsService.isMobile()"
        [tabIndex]="tocMenuOpen ? '0' : '-1'"
        (click)="toggleTocMenu()"
  >
    <img *ngIf="epubCoverImageSrc" class="epub-cover" alt="cover" [src]="epubCoverImageSrc">
    <p *ngIf="epubWritersString" class="epub-creator">{{epubWritersString}}</p>
    <p *ngIf="epubTitle" class="epub-title">{{epubTitle}}</p>
    <hr *ngIf="epubWritersString || epubTitle">
    <ol *ngIf="epubToc && epubToc.length > 0" role="menu">
      <ng-container *ngTemplateOutlet="recursiveMenu; context: {$implicit: epubToc}"/>
    </ol>
  </div>

</ion-content>

<ng-template #recursiveMenu let-list>
  <ng-container *ngFor="let item of list">
    <li role="menuitem">
      <a *ngIf="item.href"
            [href]="'ebook/' + epubFileName + '/' + item.href"
            [tabIndex]="tocMenuOpen ? '' : '-1'"
            (click)="openChapter($event, item.href)"
      >{{item.label}}</a>
      <ol *ngIf="item.subitems?.length > 0" role="menu">
        <ng-container *ngTemplateOutlet="recursiveMenu; context: {$implicit: item.subitems}"/>
      </ol>
    </li>
  </ng-container>
</ng-template>
